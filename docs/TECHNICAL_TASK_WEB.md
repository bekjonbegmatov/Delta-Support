# Техническое задание: Web-админ панель для STELS-Support

## 1. Общее описание
Необходимо разработать веб-интерфейс (Admin Panel) для управления ботом поддержки. Панель должна обеспечивать работу менеджеров с чатами, настройку AI и управление конфигурациями проекта.

**Стек технологий:**
- **Backend:** Python + FastAPI (асинхронный, высокая производительность).
- **Database:** PostgreSQL / SQLite (через Tortoise ORM, общий с ботом).
- **Frontend:** Jinja2 Templates + JavaScript (Vanilla / Plugins) + HTMX (опционально).
- **Стилизация:** Bootstrap 5 / TailwindCSS (подключенный через CDN или статику).

---

## 2. Архитектура и Трехсторонняя Синхронизация
Система должна обеспечивать **полную синхронизацию** между тремя точками взаимодействия:
1.  **Пользователь** (в личном чате с ботом).
2.  **Менеджер в Админке** (Web-интерфейс).
3.  **Менеджер в Telegram Группе** (через форум-топики).

### Логика синхронизации:
*   **Пользователь пишет боту:**
    *   Сообщение сохраняется в БД (видно в Админке).
    *   Сообщение пересылается в соответствующий Топик группы (видно другим менеджерам).
*   **Менеджер пишет в Админке:**
    *   Сообщение сохраняется в БД.
    *   Бот отправляет сообщение Пользователю.
    *   Бот дублирует сообщение в Топик группы (чтобы коллеги видели ответ).
*   **Менеджер пишет в Топик группы:**
    *   Бот перехватывает сообщение.
    *   Сообщение сохраняется в БД (появляется в Админке).
    *   Бот отправляет сообщение Пользователю.

Таким образом, история переписки везде идентична.

1.  **FastAPI** запускается как отдельный сервис или в одном Event Loop с ботом.
2.  **WebSocket** (опционально) для обновлений чатов в реальном времени.
3.  **JWT Authentication** для безопасности API.

---

## 3. Функциональные модули

### 3.1. Аутентификация и Роли
**Функционал:**
- Страница входа (Login).
- Ролевая модель:
    - **Super Admin:** Полный доступ, создание/удаление менеджеров, системные настройки.
    - **Manager:** Только доступ к чатам и ответам.

**Необходимые изменения в БД:**
- Таблица `AdminUser` (id, username, password_hash, role, is_active).

### 3.2. Раздел "Чаты" (Support Desk)
Это основное рабочее место менеджера.

**Интерфейс:**
- **Список чатов:** Слева. Фильтры (Активные, Ожидают ответа, Закрытые). Индикаторы статуса (Эмодзи).
- **Окно диалога:** Справа.
    - История переписки (сообщения пользователя, AI и менеджеров).
    - Отображение медиафайлов (фото, видео, документы), отправленных пользователем.
    - Поле ввода ответа.
    - Кнопка "Прикрепить файл" (отправка медиа от лица бота).
    - Кнопка "Закрыть тикет" / "Вернуть AI".

**Интеграция:**
- При отправке сообщения из админки, оно должно улетать пользователю в Telegram через Bot API.
- В БД сообщение сохраняется с типом `manager`.

### 3.3. Раздел "Настройки AI и Промптов"
Позволяет менять поведение бота без перезагрузки кода.

**Функционал:**
- Редактор системного промпта (System Prompt) для AI.
- Настройка параметров генерации (Temperature, Max Tokens).
- Включение/выключение AI ответов.

**Необходимые изменения в БД:**
- Таблица `SystemConfig` (key, value, description). Данные из `.env` (промпты) переезжают сюда.

### 3.4. Управление Базами Знаний (External DBs)
Интерфейс для добавления сторонних баз данных, к которым AI имеет доступ.

**Функционал:**
- Список подключенных баз.
- Кнопка "Добавить подключение":
    - Имя (название проекта).
    - Тип (Postgres/SQLite).
    - Строка подключения (Connection String).
    - Описание (чтобы AI знал, что там искать).
- Кнопка "Проверить соединение".

### 3.5. Логи и Аналитика (Опционально)
- График количества обращений.
- Лог действий менеджеров.

---

## 4. Требования к UI/UX
- **Стиль:** Минимализм, "Clean UI". Светлая/Темная тема.
- **Адаптивность:** Корректное отображение на десктопе и планшетах.
- **Удобство:** Горячие клавиши для отправки (Ctrl+Enter), быстрая загрузка истории.

---

## 5. Техническая реализация (API Endpoints Draft)

### Auth
- `POST /api/auth/login` - Получение JWT токена.
- `GET /api/auth/me` - Информация о текущем пользователе.

### Users (Admin only)
- `GET /api/users` - Список менеджеров.
- `POST /api/users` - Создать менеджера.
- `DELETE /api/users/{id}` - Удалить.

### Chats
- `GET /api/chats` - Список чатов (с пагинацией и фильтрами).
- `GET /api/chats/{id}/messages` - История сообщений.
- `POST /api/chats/{id}/send` - Отправить сообщение (текст/медиа).
- `POST /api/chats/{id}/status` - Изменить статус (close/open).

### Config
- `GET /api/config` - Получить текущие настройки.
- `PUT /api/config` - Обновить настройки (промпты, ключи).
- `POST /api/datasources` - Добавить внешнюю БД.

---

## 6. План разработки
1.  Настройка FastAPI и интеграция с Tortoise ORM существующего проекта.
2.  Реализация JWT авторизации и создание первого супер-админа.
3.  Создание API для чтения чатов и истории.
4.  Реализация отправки сообщений через экземпляр Бота.
5.  Разработка Frontend-части (Jinja2 Templates + JS).
6.  Тестирование и деплой.
